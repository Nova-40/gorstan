// /src/engine/storyProgress.js
// MIT License
// Copyright (c) 2025 Geoff Webster
// Gorstan v2.3.2 â€“ Story Progress Tracking System

/**
 * Central tracker for narrative progress, used by engine modules.
 * Tracks key flags, player milestones, cycles, and persistent meta states.
 */

export const storyProgress = {
  // --- Game Phase Flags ---
  intro: {
    playerNamed: false,
    jumped: false,
    splatted: false,
    pickedUpCoffee: false,
    drankCoffee: false,
    sawLavenderRabbit: false,
  },

  // --- Major Event Triggers ---
  events: {
    metChef: false,
    visitedWarehouse: false,
    talkedToLibrarian: false,
    solvedBriefcase: false,
    accessedTunnel: false,
    defiedTheDome: false,
    unlockedPolly: false,
    glitchTriggered: false,
  },

  // --- Room Memory System ---
  visitedRooms: new Set(), // use `addRoomVisit(roomId)` utility to update
  previousRoom: null, // for `stepback` command support

  // --- Scoring and Cycles ---
  score: 0,
  resetCycles: 0,
  tunnelUnlocked: false,
  scoringDisabled: false,

  // --- Traits System ---
  traits: {
    curious: false,
    ambitious: false,
    seeker: false, // unlocked when curious + ambitious
    cautious: false,
    glitchSensitive: false,
  },

  // --- NPC Relationships ---
  npcState: {
    Ayla: {
      mood: "neutral",
      summoned: 0,
      interactions: [],
    },
    Polly: {
      suspicionLevel: 0,
      liedAboutTrap: false,
      praisedPlayer: false,
    },
    Morthos: {
      trust: 0,
      memory: [],
    },
  },

  // --- Persistent Game State ---
  godMode: false,
  debugMode: false,
  tunnelForceUnlocked: false,
  permanentResetDisabled: false, // set true if player types "Gorstan" during countdown

  // --- Mystery Trail ---
  mysteryFragmentsFound: 0,
  trailCompleted: false,

  // --- Meta Inventory (retained across resets) ---
  metaInventory: [],

  // --- Utility Functions ---
  addRoomVisit(roomId) {
    if (!this.visitedRooms.has(roomId)) {
      this.visitedRooms.add(roomId);
    }
  },

  resetProgress(keepMeta = true) {
    this.intro = {
      playerNamed: false,
      jumped: false,
      splatted: false,
      pickedUpCoffee: false,
      drankCoffee: false,
      sawLavenderRabbit: false,
    };
    this.events = {
      metChef: false,
      visitedWarehouse: false,
      talkedToLibrarian: false,
      solvedBriefcase: false,
      accessedTunnel: false,
      defiedTheDome: false,
      unlockedPolly: false,
      glitchTriggered: false,
    };
    this.visitedRooms.clear();
    this.previousRoom = null;
    this.score = 0;
    this.resetCycles = 0;
    this.traits = {
      curious: false,
      ambitious: false,
      seeker: false,
      cautious: false,
      glitchSensitive: false,
    };
    this.npcState = {
      Ayla: { mood: "neutral", summoned: 0, interactions: [] },
      Polly: { suspicionLevel: 0, liedAboutTrap: false, praisedPlayer: false },
      Morthos: { trust: 0, memory: [] },
    };
    this.tunnelUnlocked = false;
    this.permanentResetDisabled = false;

    if (!keepMeta) {
      this.metaInventory = [];
      this.godMode = false;
      this.debugMode = false;
      this.trailCompleted = false;
    }
  },
};
